apiVersion: v1
kind: ConfigMap
metadata:
  name: external-dns-config
  namespace: default
data:
  Corefile: |
    .:53 {
        errors
        health
        ready
        # Simulation of a Corporate Zone
        file /etc/coredns/corp.local.db corp.local
        prometheus :9153
        cache 30
        loop
        reload
        loadbalance
    }
  corp.local.db: |
    corp.local.            IN      SOA     ns.corp.local. hostmaster.corp.local. 2015082541 7200 3600 1209600 3600
    corp.local.            IN      NS      ns.corp.local.
    ns.corp.local.         IN      A       1.2.3.4
    ; Mock Corporate Records
    hr.corp.local.         IN      A       10.0.0.100
    jira.corp.local.       IN      A       10.0.0.101
    sap.corp.local.        IN      A       10.0.0.102
    legacy-win.corp.local. IN      A       192.168.1.50
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns-sim
  namespace: default
  labels:
    app: external-dns-sim
spec:
  replicas: 1
  selector:
    matchLabels:
      app: external-dns-sim
  template:
    metadata:
      labels:
        app: external-dns-sim
    spec:
      containers:
        - name: coredns
          image: coredns/coredns:1.10.1
          args: ["-conf", "/etc/coredns/Corefile"]
          ports:
            - containerPort: 53
              name: dns
              protocol: UDP
            - containerPort: 53
              name: dns-tcp
              protocol: TCP
            - containerPort: 9153
              name: metrics
              protocol: TCP
          volumeMounts:
            - name: config-volume
              mountPath: /etc/coredns
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
      volumes:
        - name: config-volume
          configMap:
            name: external-dns-config
            items:
              - key: Corefile
                path: Corefile
              - key: corp.local.db
                path: corp.local.db
---
apiVersion: v1
kind: Service
metadata:
  name: external-dns-service
  namespace: default
spec:
  selector:
    app: external-dns-sim
  ports:
    - port: 53
      targetPort: 53
      protocol: UDP
      name: dns
    - port: 53
      targetPort: 53
      protocol: TCP
      name: dns-tcp
